name: "Build iOS IPA"

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: "Export method for the generated IPA (app-store, ad-hoc, development, enterprise)"
        required: false
        default: "app-store"

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    env:
      FLUTTER_VERSION: "3.35.4"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Pre-cache iOS artifacts
        run: flutter precache --ios

      - name: Install Dart & Flutter dependencies
        run: flutter pub get

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: pod install

      - name: Import signing certificates and provisioning profiles
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERT_P12 }}
          p12-password: ${{ secrets.IOS_CERT_PASSWORD }}
          profile-base64: ${{ secrets.IOS_PROFILE }}

      - name: Build IPA
        env:
          EXPORT_METHOD: ${{ github.event.inputs.export_method || 'app-store' }}
        run: |
          flutter build ipa \
            --release \
            --build-number ${{ github.run_number }} \
            --export-method ${EXPORT_METHOD}

      - name: Archive build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: |
            build/ios/ipa/*.ipa
            build/ios/archive/*.xcarchive
